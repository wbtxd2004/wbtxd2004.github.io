---
layout: post
category: 记录
title:  网件WNDR4300刷openwrt学习收藏
date:   2015-12-02 16:37:05
tagline: by WuBin 武斌
tags: [WNDR4300,路由器,openwrt]
published: true
author: wubin

---

本篇文档是转自gygy[石像鬼gargoyle固件 R51 使用教程](https://github.com/gygy/gygy.github.io)。

<!--more-->


# TITLE: 石像鬼gargoyle固件 R51 使用教程
# 1 说明
## 1.1 初始无线密码
默认ssid： **gargoyle**
默认无线密码： **Gargoyle** ,注意第一个字母 **大写**
默认密码，请在刷机完成后进行修改
## 1.2 后台默认帐号和密码
默认管理员帐号： root
默认root密码： password
默认密码，请在刷机完成后进行修改
## 1.3 ssh默认帐号和密码
默认管理员帐号： root
默认root密码： password
该密码和后台密码是相同的
## 1.4 gargoyle后台GUI
地址 http://192.168.1.1
## 1.5 LUCI后台面板
地址http://192.168.1.1:8081
## 1.6 默认地址
- 石像鬼 的gui进入方式 http://192.168.1.1
- luci 面板的进入方式为 http://192.168.1.1:8081
- transmission 地址 http://192.168.1.1:9091/transmission/web/
- aria 地址 http://192.168.1.1/yaaw/    或者  http://192.168.1.1/webui-aria2/
- 电驴  http://192.168.1.1:4711
- 路由器上的网站 http://192.168.1.1:81
- 数据库 管理http://192.168.1.1:81/phpmyadmin
- Webdav  http://192.168.1.1:888/webdav/

# 2 主要特性
- *拥有石像鬼和openwrt全部特性*
- 石像鬼gui和luci双界面
- 13信道
- 石像鬼全插件全主题
- web认证
- *广告屏蔽*
- 迅雷
- 打印服务器
- 翻WALL(ss+chinadns+pdnsd),可以任意切换
- 百度云 最新版
- IPTV电视
- 网络共享，
- openvpn
- aria2全功能版本
- 优酷路由宝
- 摄像头监控
- Transmission（最新增强版）
- MiniDLNA(支持rmvb,全功能,自动扫描,支持中文)
- UPnP重定向
- 硬盘休眠
- 手机控制ColorBox
- sqm-qos
- 多拨（ mwan3,nwan，Macvlan 等）
- 数据统计
- 流量监控( 可以监控用户浏览的URL，查询的关键词 )
- MMC/SD界面
- kms 服务器带luci界面
- 翻墙黑白名单的设置
- 进程优先级自动调整
- 守护进程的设置
- ddns增强脚本
- 端口镜像(路由器监控接口)
- 控制进程数量设置


# 3 刷机
下面介绍两种，能够刷本固件的方法。在刷机固件中，一共有两种文件格式，一种为 **img** 格式，一种为 **tar** 格式。
其中 **img** 格式只能用 **tftp** 的方法进行刷入。而 **tar** 也只能通过 已刷了Openwrt的WEB端进行刷入。下面分别说明
两种不同的刷入方法：
## 3.1 TFTP刷机方法
注意，不管刷机之前是哪个版本，或是原厂固件，或是其他第三方固件，都可以直接使用tftp刷入。一般无需先转刷原厂固件
### 3.1.1 windows下面刷机方法

- 将PC用网线连接到设备的 LAN口 ，将PC的IP设置为 192.168.1.X （此例中IP地址设置为 192.168.1.2 ），子网掩码为 255.255.255.0 ，其他项目可不必设置。
- 按路由器开关，将路由器断电；
- 用 牙签，或其他尖物 按住设备背面的 *Restore Factory Settings* 按钮（机身背面的红色小圆孔）
- 开启设备电源开关；
- 观察电源灯（此时保持按住Restore Factory Settings按钮不要松手），直到电源灯由 橙色闪烁 状态变到 绿色闪烁 状态（说明设备已经进入到了 *TFTP修复模式* ）；
- win下dos命令c

	注意，假设openwrt-ar71xx-nand-wndr3700v4-ubi-factory.img在文件夹C:\中

	<pre>
	cd C:\
	tftp -i 192.168.1.1 put openwrt-ar71xx-nand-wndr3700v4-ubi-factory.img
	</pre>


- 文件传送完毕后，等待80秒左右，设备会自动重启（请耐心等待，切勿将路由器手动断电）。至此，TFTP修复完成。
- 设备重启后，看到亮绿灯，一定先手动断电一次，再重启。 否则可能没有5G 这不是BUG，其他openwrt也是一样的。
- 如果恢复过程中断或失败，重复上述步骤再做尝试。

	**注：如果恢复过程中断或失败，重复上述步骤再做尝试。**

### 3.1.2 linux下面刷机方法
同样，按以上方法进入TFTP修复模式，然后按下面步骤

- 输入“tftp”，出现“tftp>”提示符；
- 输入“verbose”，出现“Verbose mode on.”提示；
- 输入“binary”，出现“mode set to octet.”提示；
- 输入“trace”，出现“Packet tracing on.”提示；
- 输入“rexmt 1”，每格一秒尝试一次推送；
- 输入“timeout 60”，推送尝试的时间不超过60秒；
- 输入“connect 192.168.1.1”，连接路由器（实际上并没连接，只是为连接作好准备）；
- 输入“put openwrt-ar71xx-nand-wndr3700v4-ubi-factory.img”；

以上命令，可以用下面一句命令代替


	cd img文件所在文件夹
	echo -e "binary\nrexmt 1\ntimeout 60\ntrace\nput openwrt-ar71xx-nand-wndr3700v4-ubi-factory.img\n" | tftp 192.168.1.1


## 3.2 WEB刷入方法
- 登陆luci后台
- 点击**系统**菜单
- 点击**备份/升级**菜单
- 在**动作**页面，在**刷写新的固件**位置选择 需要刷入的 **tar**固件。
- 注意**不要点击保留配置文件**

# 4 第一次进入

- 刷机成功后，通过有线 或 无线的网络，可以连接到路由器。

- 刷机成功后，访问LUCI后台地址 http://192.168.1.1:8081 ，登录的时候，输入用户名**root**，密码**password**

- 从 LUCI菜单中 ，找到 系统 --- 一键设置 。

- 在 打开的 **一键设置** 页面， 根据提示 设置PPOE帐号、密码，设置好 无线的帐号及密码，设置好IP地址，设置好基本设置

- 注意：新手或者不熟悉的，请不要在 **一键设置** 中 设置adbyby。 不使用翻墙的，请也不要其余ss

- 一键设置 设置完成并保存后， 到**系统** -- **快捷命令** --点击运行 **一键设置(luci)** 请重启路由器。

- 路由器 重启后，请测试 上网 及 翻墙是否正常。

- 石像鬼的界面是 http://192.168.1.1 , 以上步骤设置完成后，大家也可以进入石像鬼界面，查看石像鬼下面的功能。

**注意，一定要注意看一键设置的说明。**


# 5 设置无线
默认已经开启无线，并设置了默认无线密码。为安全起见，建议在设置完成ss后，进行改掉。

可以在 石像鬼的GUI 或 LUCI界面 进行修改。下面步骤以石像鬼界面为例：

菜单位置： 连接 --- 基本设置

# 6 修改后台密码
菜单：以luci后台为例 系统 ----- 管理权
进行修改，并保存。
修改后台密码，在一键设置中也可以



# 7 设置ssh
一共有两个步骤。
## 7.1 ssh设置
菜单：以luci后台为例 系统 ----- 管理权
进行修改密码，并保存。

## 7.2 运行快捷命令
菜单：以luci后台为例 系统 ----- 快捷命令

操作：找到 ssh-fix 按钮，点击 运行

## 7.3 测试设置情况

	ssh root@192.168.1.1


# 8 翻墙步骤及方案

- 一旦路由器 能正常上网后，可以设置翻墙。翻墙需要shadowsocks帐号及密码，shadowsocks的服务端建议开启 UDP转发

- 从 LUCI菜单中 ，找到 服务 ---  shadowsocks 。记住仅仅修改里面的 服务器地址 服务器端口 本地端口 密码 加密方式。其他任何设置不要乱动。

- 从 LUCI菜单中 ，找到 系统 ---  快捷命令 。

- 在 打开的 快捷命令 页面中，有三种翻墙方案。推荐第一种翻墙方案： 《翻墙方案一：带pdnsd》 。 只需要点击 运行 按钮 就可以

- 三种翻墙方案，可以任意切换。

# 9 FTP服务器设置

- 登录LUCI界面后，点击 服务--- FTP服务器

- 点击虚拟用户页面

- 设置 启用 打勾，用户名 默认ftp不用修改

- 新建一个虚拟用户，可以设置任意的用户名+对应的密码，设置该用户对应的主目录（如/mnt/sda2）

- 设置文件夹的权限(如777)，是否允许写及创建目录，是否允许上传，是否允许其他权限。

# 10 百度云设置

- 登录LUCI界面后，点击 服务--- SyncY百度云

- 开机自动启动 打勾，并点击 绑定百度帐号

- 根据提示的URL路径 及 出现的激活码，进入链接输入激活码，成功后返回

- 完成绑定

- 设置 日志文件 路径 ，比如 /mnt/sda2/tmp/baidu.log，建议设置在外部硬盘上面。

- 设置需要同步的目录。比如 本地目录设置为/mnt/sda2/syncy/upload 远端目录 为/apps/SyncY/upload ,并设置同步方式。

- 保存和应用 设置。然后重启路由器

- 可以多测试几次，如仍有问题，可以到 快捷命令中--点击 修复百度云

# 11 设置翻墙黑名单

- 登录LUCI界面后，点击 服务--- 设置翻墙黑名单

- 设置翻墙黑名单 ：所有需要 走ss路线的域名。

- 设置方法是： 按照 server/.lsxszzg.com/127.0.0.1#7913 的格式 在任意位置插入一行

	<pre>
	#你自定义的规则，可以插入在下面
	# 严格按照格式，一句一行
	# 例子
	#server/.lsxszzg.com/127.0.0.1#7913
	#设置完毕，需要重启路由器，或者重启ss相关服务
	#下面是固件 自带的规则
	server/.lsxszzg.com/127.0.0.1#7913
	</pre>



- 保存 并重启路由器

# 12 设置翻墙白名单

- 登录LUCI界面后，点击 服务--- 设置翻墙白名单

- 设置翻墙白名单 ：所有需要 不走ss路线的域名。

- 设置方法是： 按照 server/.taobao.com/114.114.114.114 的格式 在任意位置插入一行
	
	<pre>
  		#每一行 写一个地址，严格按格式写
		# 黑白名单 不能冲突
		# 例子如下：
		# server/.taobao.com/114.114.114.114
		#设置完毕，需要重启路由器，或者重启ss相关服务
		#注意 如果需要将黑名单里面的地址，转成不走ss。首先需要将黑名单去掉该地址，并且修改ignore.list
		server/#/114.114.114.114

		#for ddns
		server/.oray.com/114.114.114.114
		server/.3322.org/114.114.114.114
		server/.no-ip.com/114.114.114.114
		server/.ChangeIP.com/114.114.114.114
		server/.dyn.com/114.114.114.114
		server/.3322.net/114.114.114.114
		server/.dhs.org/114.114.114.114
		server/.dyns.cx/114.114.114.114
  </pre>

- 保存 并重启路由器

# 13 广告屏蔽

- 登录LUCI界面后，点击 服务--- 广告屏蔽

- 启动 ：启动 一定要打勾， 启用透明代理 ：请保持默认。

- 监听地址 ：192.168.1.1 或者是0.0.0.0， 请保持默认。

- 其他 任何设置 保持默认

- 点击 保存和应用 ，如发现保存1次，没有运行，可以多保存应用几次 。

- 重启路由器，检查 广告屏蔽 是否已启动。

- 如 还是没有启动，可以手工 强制启动adbyby 服务

## 13.1 控制ADbyby的进程数量
点击菜单 系统 --- 计划任务
添加或反注释下面一句。其中下面的 数字 1 代表每隔1分钟对ADbyby进行进程控制一次。

	*/1 * * * * sh /etc/config/psnumw


## 13.2 防止adbyby意外停止
- LUCI菜单 高级 ---- 守护进程
- 修改下面这句
	<pre>
	DAEMONNAME_LIST"adbyby"
	</pre>
- 点击菜单 系统 --- 计划任务
添加或反注释下面一句。其中下面的 数字 1 代表每隔1分钟检查一次。
	
	<pre>*/1 * * * * sh /etc/config/daemonw</pre>


# 14 增强无线设置
Opewrt对无线的支持，一般能支持到150M，这是Openwrt共有的。可以按照下面的方法，增强无线设置

- 登录LUCI界面后，点击 系统--- 快捷命令

- 点击运行 增强无线设置

# 15 IPTV设置

- 用 网线 将 路由器的LAN 4口 连接到 电视IPTV盒子上面

- 点击 系统 -- 快捷命令 ，点击运行 IPTV设置(lan4)

# 16 Aria2设置
- 点击 系统 -- Aria2配置
- 全局设置 --- 启用
- 文件和位置 ：设置默认下载路径 ，例如 /mnt/sda2/tmp/aria2
- 其他 任何设置 可保持默认
- 点击 保存和应用 。
- 重启路由器，检查 aria2 是否已启动。
- 如 还是没有启动，可以手工 启动aria2 服务

# 17 迅雷设置
固件已集成迅雷接口，有两种方法，可以安装迅雷，方法一是手工安装。方法二是 到 系统--快捷命令 点击“安装迅雷”进行自动安装。
方法一是手工方法：可以按下列手工的方法，进行使用：

- 在固件下载目录中，下载 xunlei.tar.gz 文件
- 将 xunlei.tar.gz 文件解压到 外置硬盘中。 或者将文件 放到 /usr/share 中。
- 访问luci 找到 迅雷 设置，设置迅雷的路径 为以上路径。
- 观察迅雷 luci界面，在启动信息处，是否能够取得激活码。
- 第4步如果没有效果，可以尝试，在第2步的迅雷路径中，执行 ./portal 可以取得迅雷的激活码。
- 访问 远程迅雷，进行绑定
- 不管是哪种方法，出现问题，都可以到 web远程迅雷 处 解除或删除设备。或删除配置文件 （cd /usr/share/xunlei && rm -rf cfg/）

方法二，可以用在线安装的方法

- 从 LUCI菜单中 ，找到 系统 ---  快捷命令 。
- 执行 安装迅雷(要联网)
- 执行的过程中，需要联网。并且注意提示信息。
- 该方法，迅雷自动安装到  /usr/share 中。



# 18 设置samba共享
需要按下面步骤设置
菜单：以luci后台为例 服务 ----- 网络共享


接下来，登陆ssh，输入如下命令

	smbpasswd -a user1

注意 user1 和 上面的 允许用户 设置的用户一致。输入以上命令后，根据提示输入两次密码。

最后，我们测试。

- 在windows 访问samba
  
	\\192.168.1.1


用户名为 user1 ， 密码是smbpasswd命令后输入的密码。大家可以根据情况，将以上的 user1 取代成自己的。

# 19 DDNS设置
DDNS动态域名，一共有三种方法设置。下面分开说明。 从下面方法选择一种适合自己的方法即可
## 19.1 ddns设置脚本
- 系统 --- ddns设置脚本
- 尽量不要修改脚本的内容，只需要根据提示修改相关内容即可。
- 到 系统 --- 计划任务 ， 反注释或添加下面语句


	<pre>*/8 * * * * sh /etc/config/ddnslitew</pre>

表示每8分钟，自动更新ddns
## 19.2 石像鬼设置DDNS
石像鬼界面 --- 连接 --- 动态域名 ，根据提示设置即可。
## 19.3 LUCI界面设置DDNS
LUCI界面 --- 服务 --- 动态DNS
注意来源接口要选择 pppoe-wan ，否则在多拨或翻墙的情况下，ddns获取的ip是不正确的。

# 20 多拨叠加设置
在多拨之前，一定要确认你所在的地区和线路是支持多拨的。大部分地区，电信和联通已经限制了多拨
下面是多拨叠加的设置方法：

- 首先 网络 --- 接口 --- WAN 编辑 ---- 高级设置
将 使用网关跃点 设置为 40

- 网络 --- 虚拟WAN接口

启动：打勾
虚拟WAN接口数量：填写数量
使用WAN口进行拨号：根据各自情况选择
断线自动重连：可以打勾
最低在线接口数：根据各自情况填写

填写完毕以上内容后， 保存并应用

- 网络 --- 虚拟WAN接口

点击 重新并发拨号

- 系统 --- 快捷命令
 运行 多拨设置

- 如果设置了多拨，但后来不使用多拨了，请不要启用虚拟WAN接口
- 不使用多拨，请 到 网络 --- 负载均衡 --- 规则 ，清空里面的规则。否则会 影响网络的速度

# 21 miniDLNA设置
本固件的miniDLNA是全功能版本，支持rmvb等不同的格式，支持自动扫描

- LUCI 界面--- miniDLNA
- 启用 打勾
- 根目录： 设置为：基本目录
- 媒体目录： 一定要设置正确。
比如 设置为 /tmp/usb_mount/0000a87d-02/test
一定要注意目录。注意目录是否正确及是否有权限。石像鬼的硬盘挂载位置为：/tmp/usb_mount/xxx/dir (建议用此格式填写)，也可以到石像鬼的界面指定。
或到挂载点中查看。

# 22 守护进程
- 系统 --- 守护进程
- 尽量不要修改脚本的内容，只需要根据提示修改相关内容即可。
- 下面语句的 数字 8 代表每隔8分钟执行一次脚本。

	<pre>DAEMONNAME_LIST"syncy xunlei adbyby"   # 设置需要守护的进程，用空格分开，仅仅修改这句就可以了。</pre>

- 到 系统 --- 计划任务 ， 反注释或添加下面语句

	<pre>*/8 * * * * sh /etc/config/daemonw</pre>


# 23 外置脚本
- 系统 --- 外置脚本
- 可以将一些外置脚本粘帖到此处。
- 到 系统 --- 计划任务 ， 反注释或添加下面语句。
- 下面语句的 数字 8 代表每隔8分钟执行一次脚本。

	*/8 * * * * sh /etc/config/autoshw

# 24 设置访客网络
- 访问石像鬼界面
- 点击 连接  --- 基本设置 菜单
- 拉到底部，你会看到一个 访客网络 启用它。